<div class="card">
    <div class="card-header">
        <form class="md-float-material form-material mt-10" #form="ngForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group form-primary">
                                <input
                                    type="text"
                                    name="factura_folio"
                                    class="form-control"
                                    [(ngModel)]="fecha.folio"
                                />
                                <span class="form-bar"></span>
                                <label class="float-label">ID de la compra</label>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group form-primary">
                                <input
                                    type="date"
                                    name="fecha_inicial"
                                    class="form-control"
                                    [(ngModel)]="fecha.inicial"
                                    [required]="fecha.folio == ''"
                                />
                                <span class="form-bar"></span>
                                <label class="float-label">Fecha inicial</label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group form-primary">
                                <input
                                    type="date"
                                    name="fecha_final"
                                    class="form-control"
                                    [(ngModel)]="fecha.final"
                                    [required]="fecha.folio == ''"
                                />
                                <span class="form-bar"></span>
                                <label class="float-label">Fecha final</label>
                            </div>
                        </div>
                    </div>

                    <h4 class="sub-title m-t-20">Filtro por producto</h4>

                    <div class="row">
                        <div
                            class="col-md-10"
                            [hidden]="busqueda_producto.productos.length > 0"
                        >
                            <div class="form-group form-primary">
                                <input
                                    type="text"
                                    name="criterio"
                                    class="form-control"
                                    [(ngModel)]="busqueda_producto.criterio"
                                />
                                <span class="form-bar"></span>
                                <label class="float-label">Criterio</label>
                            </div>
                        </div>

                        <div
                            class="col-md-10"
                            [hidden]="busqueda_producto.productos.length == 0"
                        >
                            <div class="form-group form-primary">
                                <select
                                    name="pro_codigo"
                                    id="pro_codigo"
                                    class="form-control"
                                    [(ngModel)]="fecha.producto"
                                >
                                    <option value="" selected disabled></option>
                                    <option
                                        value="{{ producto.sku }}"
                                        *ngFor="
                                            let producto of busqueda_producto.productos
                                        "
                                    >
                                        {{
                                            producto.sku +
                                                " - " +
                                                producto.descripcion
                                        }}
                                    </option>
                                </select>
                                <span class="form-bar"></span>
                                <label class="float-label"
                                    >Selecciona un producto</label
                                >
                            </div>
                        </div>

                        <div class="col-md-2">
                            <button
                                class="btn btn-sm btn-outline-info btn-block http-disabled"
                                (click)="buscarProducto()"
                                placement="top"
                                ngbTooltip="Buscar productos"
                            >
                                <i class="fa fa-search fa-2x"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6">
                            <button
                                class="btn btn-outline-info btn-sm btn-block http-disabled"
                                (click)="cargarDocumentos()"
                                [disabled]="!form.valid"
                                placement="top"
                                ngbTooltip="Buscar documentos"
                            >
                                <i class="fa fa-search fa-2x"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <button
                                class="btn btn-outline-info btn-sm btn-block m-t-10 http-disabled"
                                (click)="descargarExcel()"
                                [disabled]="fecha.excel == ''"
                                placement="top"
                                ngbTooltip="Descargar excel"
                            >
                                <i class="fa fa-file-download fa-2x"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="card-block table-responsive">
        <div class="row">
            <div class="col-md-12">
                <table class="table table-striped" id="compra_compra_historial">
                    <thead>
                        <tr>
                            <th>Folio</th>
                            <th>Proveedor</th>
                            <th>Total</th>
                            <th>UUID</th>
                            <th>Estado</th>
                            <th>Creador</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let orden of ordenes">
                            <td>
                                <button
                                    class="btn btn-info btn-sm btn-block"
                                    (click)="detalleVenta(modalventa, orden.id)"
                                >
                                    {{ orden.serie + " " + orden.folio }}
                                </button>
                            </td>
                            <td>{{ orden.proveedor }}</td>
                            <td>
                                $
                                {{
                                    commaNumber(orden.total | number : "1.2-2")
                                }}
                            </td>
                            <td>{{ orden.uuid }}</td>
                            <td>{{ orden.fase }}</td>
                            <td>{{ orden.nombre }}</td>
                            <td>{{ orden.expired_at }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #modalventa let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Informacion de la compra</h4>
        <button
            type="button"
            class="close"
            aria-label="Close"
            (click)="d('Cross click')"
            id="cerrar_modal"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body table-responsive">
        <div class="form-horizontal form-bordered">
            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Folio</label>
                <div class="col-sm-10 inline-block">
                    <h5>{{ data.serie + " " + data.folio }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Proveedor</label>
                <div class="col-sm-10 inline-block">
                    <h5>{{ data.rfc + " - " + data.proveedor }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Almacén</label>
                <div class="col-sm-10 inline-block">
                    <h5>
                        {{ $any(data).empresa + " - " + $any(data).almacen }}
                    </h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Periodo de pago</label>
                <div class="col-sm-10 inline-block">
                    <h5>{{ $any(data).periodo }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Moneda</label>
                <div class="col-sm-10 inline-block">
                    <h5>{{ $any(data).moneda + " | " + data.tipo_cambio }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Total</label>
                <div class="col-sm-10 inline-block">
                    <h5>$ {{ commaNumber(data.total | number : "1.2-2") }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Resta</label>
                <div class="col-sm-10 inline-block">
                    <h5>$ {{ commaNumber(data.resta | number : "1.2-2") }}</h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2"
                    >Ediciones del documento</label
                >
                <div class="col-sm-10 inline-block">
                    <table
                        class="table table-striped m-t-10"
                        *ngIf="data.ediciones.length > 0"
                    >
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Fecha de edición</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of data.ediciones">
                                <td>{{ row.nombre }}</td>
                                <td>{{ row.created_at }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <h5 *ngIf="data.ediciones.length == 0">
                        Sin ediciones registradas
                    </h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Pagos</label>
                <div class="col-sm-10 inline-block">
                    <table
                        class="table table-striped m-t-10"
                        *ngIf="data.pagos.length > 0"
                    >
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tipo de ingreso</th>
                                <th>T.C</th>
                                <th>Total</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of data.pagos">
                                <td>
                                    {{
                                        row.pago_operacion == 0
                                            ? row.pago_condocumento
                                            : row.pago_operacion
                                    }}
                                </td>
                                <td>
                                    {{
                                        row.pago_operacion == 0
                                            ? "Nota de credito"
                                            : "Pago a proveedor"
                                    }}
                                </td>
                                <td>
                                    $
                                    {{ commaNumber(row.tc | number : "1.2-2") }}
                                </td>
                                <td>
                                    $
                                    {{
                                        commaNumber(
                                            row.monto | number : "1.2-2"
                                        )
                                    }}
                                </td>
                                <td>{{ row.fecha }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <h5 *ngIf="data.pagos.length == 0">
                        Sin pagos registrados
                    </h5>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Productos</label>
                <div class="col-sm-10 inline-block table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Cantidad</th>
                                <th *ngIf="nota_credito.uuid != ''">C. Nota</th>
                                <th>Costo</th>
                                <th>Extra (MXN)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                *ngFor="
                                    let producto of final_data.productos;
                                    let index = index
                                "
                            >
                                <td>{{ producto.sku }}</td>
                                <td>
                                    {{
                                        producto.sku == "TEMPORAL"
                                            ? producto.descripcion_2
                                            : producto.descripcion
                                    }}
                                </td>
                                <td>{{ producto.cantidad }}</td>
                                <td *ngIf="nota_credito.uuid != ''">
                                    <input
                                        type="number"
                                        class="form-control"
                                        name="cantidadnotacredito{{ index }}"
                                        [(ngModel)]="producto.cantidad_nota"
                                    />
                                </td>
                                <td class="no-wrap">
                                    $ {{ producto.costo | number : "1.2-2" }}
                                </td>
                                <td>
                                    <input
                                        type="number"
                                        class="form-control"
                                        name="costoextraproducto{{ index }}"
                                        [(ngModel)]="producto.costo_extra"
                                        [disabled]="
                                            !final_data.permitido_editar
                                        "
                                    />
                                </td>
                                <td>
<!--                                    <button-->
<!--                                        class="btn btn-sm btn-info btn-block"-->
<!--                                        [disabled]="-->
<!--                                            !producto.serie ||-->
<!--                                            (producto.serie &&-->
<!--                                                producto.series.length == 0)-->
<!--                                        "-->
<!--                                        (click)="-->
<!--                                            verSeries(-->
<!--                                                producto.sku,-->
<!--                                                modalserierecibidas-->
<!--                                            )-->
<!--                                        "-->
<!--                                    >-->
<!--                                        Series-->
<!--                                    </button>-->
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Seguimiento</label>
                <div class="col-sm-10 inline-block">
                    <app-new-editor
                        class="m-t-20"
                        name="seguimiento"
                        #seguimiento="ngModel"
                        [(ngModel)]="final_data.seguimiento"
                    >
                    </app-new-editor>

                    <div
                        *ngFor="let seguimiento of data.seguimiento"
                        class="m-t-20 m-b-20"
                    >
                        <div class="media chat-messages">
                            <div class="media-body chat-menu-content">
                                <div class="">
                                    <p class="chat-cont">
                                        {{
                                            seguimiento.nombre +
                                                " - " +
                                                seguimiento.created_at
                                        }}
                                    </p>
                                    <p
                                        class="chat-cont"
                                        [innerHTML]="seguimiento.seguimiento"
                                    ></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="form-group group-div"
                [hidden]="$any(data).uuid != '' && $any(data).uuid != 'N/A'"
            >
                <label class="col-form-label col-sm-2">Cargar XML</label>
                <div class="col-sm-10 inline-block">
                    <input
                        type="file"
                        class="form-control ngb-drop-zone text-center ripple light m-t-10"
                        id="xml_factura"
                        (change)="cargarXML()"
                    />
                </div>
            </div>

            <div class="form-group group-div">
                <label class="col-form-label col-sm-2"></label>
                <div class="col-sm-10 inline-block">
                    <button
                        class="btn btn-info btn-sm btn-block m-t-10 m-b-10 http-disabled"
                        (click)="guardarUUID()"
                    >
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #modalserierecibidas let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Series</h4>
        <button
            type="button"
            class="close"
            aria-label="Close"
            (click)="d('Cross click')"
            id="cerrar_modal_serie"
        >
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body table-responsive">
        <div class="form-horizontal form-bordered">
            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Series</label>
                <div class="col-sm-10 inline-block">
                    <ul class="list-group m-b-20" id="ul_series">
                        <li
                            class="list-group-item"
                            *ngFor="let serie of data.series"
                        >
                            {{ serie.serie }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</ng-template>
