<div class="container py-4 px-3" style="background:#fff; border-radius:18px; box-shadow:0 0 18px #e8eef3;">
    <div class="row mb-4">
        <div class="col-12 d-flex align-items-center gap-2">
            <i class="fa fa-receipt text-primary" style="font-size: 2.2rem;"></i>
            <h2 class="fw-bold mb-0" style="color:#1976d2;">Crear gasto</h2>
        </div>
    </div>

    <form #f="ngForm" autocomplete="off">
        <!-- PROVEEDOR -->
        <div class="row align-items-end mb-2">
            <div class="col-md-6 mb-2" [hidden]="proveedores.length > 0">
                <label class="fw-semibold mb-1 text-secondary">Proveedor</label>
                <input type="text" name="proveedor_text" class="form-control" [(ngModel)]="proveedor_text" (keyup.enter)="buscarProveedor()" />
            </div>
            <div class="col-md-6 mb-2" [hidden]="proveedores.length == 0">
                <label class="fw-semibold mb-1 text-secondary">Proveedor</label>
                <select name="proveedor_id" class="form-control" [(ngModel)]="data.proveedor.id" (change)="cambiarProveedor()">
                    <option value=""></option>
                    <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                        {{ proveedor.razon_social }} - {{ proveedor.rfc }}
                    </option>
                </select>
            </div>
            <div class="col-md-2 mb-2 d-flex align-items-center">
                <button type="button" class="btn btn-primary w-100" (click)="buscarProveedor()" [disabled]="!data.empresa">
                    <i class="fa fa-search"></i> Buscar
                </button>
            </div>
        </div>
        <hr class="my-3" />

        <div class="row mb-3 g-3">
            <div class="col-md-4">
                <label class="fw-semibold mb-1 text-secondary">Almacén</label>
                <select name="almacen" class="form-control" [(ngModel)]="data.almacen">
                    <option value="" disabled>Selecciona almacén</option>
                    <option *ngFor="let almacen of almacenes" [value]="almacen.id">
                        {{ almacen.almacen }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Fecha de entrega estimada (ETA)</label>
                <input type="date" name="fecha_entrega" class="form-control" [(ngModel)]="data.fecha_entrega" />
            </div>
            <div class="col-md-5">
                <label class="fw-semibold mb-1 text-secondary">Comentarios</label>
                <input type="text" name="comentarios" class="form-control" [(ngModel)]="data.comentarios" />
            </div>
        </div>

        <hr class="my-3" />

        <div class="row mb-3 g-3">
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Uso del CFDI</label>
                <select name="uso_cfdi" class="form-control" [(ngModel)]="data.uso_cfdi">
                    <option value="" selected disabled></option>
                    <option *ngFor="let uso of usos_cfdi" [value]="uso.id">
                        {{ uso.codigo + " - " + uso.descripcion }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Periodo de pago</label>
                <select name="periodo" class="form-control" [(ngModel)]="data.periodo">
                    <option value=""></option>
                    <option *ngFor="let periodo of periodos" [value]="periodo.id">
                        {{ periodo.periodo_en }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Metodo de pago</label>
                <select name="metodo_pago" class="form-control" [(ngModel)]="data.metodo_pago">
                    <option value="" selected disabled></option>
                    <option *ngFor="let metodo of metodos_pago" [value]="metodo.codigo">
                        {{ metodo.codigo + " | " + metodo.metodo_pago }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Impuesto</label>
                <select name="impuesto" class="form-control" [(ngModel)]="data.impuesto">
                    <option value=""></option>
                    <option value="0">0%</option>
                    <option value="16">16%</option>
                </select>
            </div>
        </div>
        <div class="row mb-3 g-3">
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Moneda</label>
                <select name="moneda" class="form-control" [(ngModel)]="data.moneda">
                    <option value=""></option>
                    <option *ngFor="let moneda of monedas" [value]="moneda.id">
                        {{ moneda.moneda }}
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="fw-semibold mb-1 text-secondary">Tipo de cambio</label>
                <input type="number" name="tipo_cambio" class="form-control" [(ngModel)]="data.tipo_cambio" min="1" step="0.01" />
            </div>
        </div>

        <hr class="my-3" />

        <!-- SECCIÓN DE PRODUCTOS -->
        <h5 class="mb-2 mt-2 fw-bold text-primary">Productos</h5>
        <div class="row mb-2 g-2 align-items-end">
            <!-- INPUT para buscar código/texto -->
            <div class="col-md-4" *ngIf="productos.length === 0">
                <label class="form-label fw-semibold">Producto (buscar por código)</label>
                <input
                    type="text"
                    name="codigo_producto"
                    class="form-control"
                    [(ngModel)]="producto.text"
                    placeholder="Escribe código y presiona Enter"
                    (keyup.enter)="buscarProducto()"
                    ngbTooltip="Escribe el código/SKU y presiona Enter para buscar."
                    placement="top"
                />
            </div>
            <!-- SELECT si hay resultados -->
            <div class="col-md-4" *ngIf="productos.length > 0">
                <label class="form-label fw-semibold">Producto</label>
                <select
                    name="producto_select"
                    class="form-control"
                    [(ngModel)]="producto.id"
                    (change)="onProductoSeleccionado()"
                    ngbTooltip="Selecciona el producto correcto de la lista"
                    placement="top"
                >
                    <option value="" disabled selected>Selecciona producto</option>
                    <option *ngFor="let prod of productos" [ngValue]="prod.id">
                        {{ prod.sku }} - {{ prod.descripcion }}
                    </option>
                </select>
            </div>
            <!-- Cantidad -->
            <div class="col-md-2">
                <label class="form-label fw-semibold">Cantidad</label>
                <input
                    type="number"
                    name="cantidad_producto"
                    class="form-control"
                    [(ngModel)]="producto.cantidad"
                    min="1"
                    placeholder="Cantidad"
                    ngbTooltip="Cantidad a agregar"
                    placement="top"
                />
            </div>
            <!-- Costo -->
            <div class="col-md-2">
                <label class="form-label fw-semibold">Costo</label>
                <input
                    type="number"
                    name="costo_producto"
                    class="form-control"
                    [(ngModel)]="producto.costo"
                    min="0"
                    placeholder="Costo"
                    ngbTooltip="Costo unitario del producto"
                    placement="top"
                />
            </div>
            <!-- Descuento -->
            <div class="col-md-2">
                <label class="form-label fw-semibold">Descuento (%)</label>
                <input
                    type="number"
                    name="descuento_producto"
                    class="form-control"
                    [(ngModel)]="producto.descuento"
                    min="0"
                    placeholder="Descuento"
                    ngbTooltip="Porcentaje de descuento"
                    placement="top"
                />
            </div>
            <!-- Botón agregar -->
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-success w-100" (click)="agregarProducto()" ngbTooltip="Agregar producto" placement="top">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-12 table-responsive mt-3">
                <div class="table-responsive rounded-3 shadow-sm my-2" style="background:#f7fafc;">
                    <table class="table table-hover align-middle mb-0" style="border-radius:12px;">
                        <thead style="background:#eaf1fb;">
                        <tr class="text-secondary text-uppercase fw-bold small">
                            <th style="border-top-left-radius:12px;">Código</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Costo</th>
                            <th>Descuento (%)</th>
                            <th style="border-top-right-radius:12px;"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let producto of data.productos; let i = index" class="bg-white">
                            <td class="fw-bold text-primary">{{ producto.text }}</td>
                            <td>{{ producto.descripcion }}</td>
                            <td>{{ producto.cantidad }}</td>
                            <td>${{ producto.costo | number: '1.2-2' }}</td>
                            <td>{{ producto.descuento }}</td>
                            <td>
                                <button type="button" class="btn btn-outline-danger btn-sm" (click)="data.productos.splice(i, 1)" ngbTooltip="Eliminar producto">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

        <hr class="my-3" />
        <div class="d-flex flex-wrap gap-3 my-3">
            <div class="px-4 py-2 rounded-3 bg-light text-secondary shadow-sm fw-semibold">
                <i class="fa fa-receipt me-1"></i> IVA:
                <span class="ms-1">${{ (totalDocumento() - totalDocumento() / 1.16) | number:'1.2-2' }}</span>
            </div>
            <div class="px-4 py-2 rounded-3 bg-light text-secondary shadow-sm fw-semibold">
                Subtotal:
                <span class="ms-1">${{ (totalDocumento() / 1.16) | number:'1.2-2' }}</span>
            </div>
            <div class="px-4 py-2 rounded-3 bg-light text-primary shadow-sm fw-semibold">
                Total:
                <span class="ms-1">${{ totalDocumento() | number:'1.2-2' }}</span>
            </div>
            <div class="px-4 py-2 rounded-3 bg-light text-success shadow-sm fw-semibold">
                Total Descuento:
                <span class="ms-1">${{ totalDescuento() | number:'1.2-2' }}</span>
            </div>
            <div class="px-4 py-2 rounded-3 bg-light text-dark shadow-sm fw-semibold">
                Total menos descuento:
                <span class="ms-1">${{ (totalDocumento() - totalDescuento()) | number:'1.2-2' }}</span>
            </div>
        </div>

        <hr class="my-3" />

        <h5 class="mb-2 fw-bold text-primary">Archivos</h5>
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="file" name="archivos" class="form-control" id="archivos" (change)="agregarArchivo()" multiple />
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <button type="button" class="btn btn-primary btn-lg w-100" (click)="crearDocumento($event)">
                    <i class="fa fa-save me-2"></i>Crear gasto / orden de compra
                </button>
            </div>
        </div>
    </form>
</div>
