<!--suppress JSUnusedLocalSymbols -->
<div class="card">
    <div class="card-header">
        <h5>Facturas pendientes</h5>
    </div>
    <div class="card-block table-responsive">
        <div class="row">
            <div class="col-md-12">
                <table
                    class="table table-striped"
                    id="contabilidad_factura_pendiente"
                >
                    <thead>
                    <tr>
                        <th>Documento</th>
                        <th>Marketplace</th>
                        <th>Cliente</th>
                        <th>RFC</th>
                        <th>Paquetería</th>
                        <th>Vendedor</th>
                        <th>Fecha</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let venta of ventas">
                        <td>
                            <button
                                class="btn btn-info btn-sm"
                                (click)="detalleVenta(modalventa, venta.id)"
                            >
                                {{ venta.id }}
                            </button>
                        </td>
                        <td>
                            {{ venta.marketplace + " / " + venta.area }}
                        </td>
                        <td>{{ venta.cliente }}</td>
                        <td>{{ venta.rfc }}</td>
                        <td>{{ venta.paqueteria }}</td>
                        <td>{{ venta.usuario }}</td>
                        <td>{{ venta.created_at }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #modalventa let-c="close" let-d="dismiss">
    <!-- MODAL HEADER -->
    <div class="modal-header d-flex align-items-center justify-content-between" style="background:#3f51b5; color:#fff;">
        <div class="d-flex align-items-center" style="gap:8px;">
            <i class="fas fa-file-invoice-dollar" style="font-size:1.3rem;"></i>
            <h5 class="modal-title fw-bold mb-0">
                Detalle de factura <span class="fw-bold">#{{ data.documento }}</span>
            </h5>
        </div>
        <button type="button" class="btn p-0 m-0 text-white" (click)="modalReference.close()" aria-label="Close" style="font-size:1.3rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="modal-body pt-3 pb-1" style="background:#f8fafc;">
        <!-- Tarjetas superiores -->
        <div class="row g-4 mb-3">
            <div class="col-md-4">
                <div class="card border shadow-sm rounded-4 h-100">
                    <div class="card-body d-flex align-items-center py-3">
                        <span style="display:inline-flex; align-items:center; justify-content:center; background:#eaf4ff; border-radius:10px; width:44px; height:44px;">
                          <i class="fas fa-store text-primary" style="font-size:1.2rem;"></i>
                        </span>
                        <div class="ms-3 ps-2" style="margin-left: 15px;">
                            <div class="text-uppercase small fw-bold text-secondary mb-1">Marketplace / Área</div>
                            <div class="fw-semibold text-dark">{{ data.marketplace }} / {{ data.area }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border shadow-sm rounded-4 h-100">
                    <div class="card-body d-flex align-items-center py-3">
                        <span style="display:inline-flex; align-items:center; justify-content:center; background:#eaf4ff; border-radius:10px; width:44px; height:44px;">
                          <i class="fas fa-user-tie text-info" style="font-size:1.2rem;"></i>
                        </span>
                        <div class="ms-3 ps-2" style="margin-left: 15px;">
                            <div class="text-uppercase small fw-bold text-secondary mb-1">Vendedor</div>
                            <div class="fw-semibold text-dark">{{ data.vendedor || '-' }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border shadow-sm rounded-4 h-100">
                    <div class="card-body d-flex align-items-center py-3">
                        <span style="display:inline-flex; align-items:center; justify-content:center; background:#eaf4ff; border-radius:10px; width:44px; height:44px;">
                          <i class="fas fa-truck text-success" style="font-size:1.2rem;"></i>
                        </span>
                        <div class="ms-3 ps-2" style="margin-left: 15px;">
                            <div class="text-uppercase small fw-bold text-secondary mb-1">Paquetería</div>
                            <div class="fw-semibold text-dark">{{ data.paqueteria || '-' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cliente -->
        <div class="mb-3">
            <div class="bg-white border rounded-4 px-3 pt-3 pb-2 shadow-sm mb-3">
                <div class="row g-2 align-items-center">
                    <!-- Icono -->
                    <div class="col-md-2 d-flex justify-content-center">
                        <i class="fas fa-user text-success" style="font-size:1.8rem;"></i>
                    </div>

                    <!-- Columna Cliente -->
                    <div class="col-md-5">
                        <div class="fw-bold text-secondary mb-1">Cliente</div>
                        <div class="fw-semibold" style="font-size:1rem;">{{ data.cliente }}</div>
                        <div class="text-secondary small">{{ data.rfc }}</div>
                    </div>

                    <!-- Columna Contacto -->
                    <div class="col-md-5">
                        <div class="fw-bold text-secondary mb-1">Contacto</div>
                        <div class="d-flex flex-column gap-1 small text-muted mb-2">
                            <span *ngIf="data.correo"><i class="fas fa-envelope me-1"></i>{{ data.correo }}</span>
                            <span *ngIf="data.telefono"><i class="fas fa-phone me-1"></i>{{ data.telefono }}</span>
                            <span *ngIf="data.telefono_alt"><i class="fas fa-phone-alt me-1"></i>{{ data.telefono_alt }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Productos -->
        <div class="mb-3">
            <div class="bg-white border rounded-4 shadow-sm px-3 pt-3 pb-2">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-boxes text-success me-2" style="font-size:1.1rem;"></i>
                    <span class="fw-bold text-secondary" style="margin-left: 5px">Productos</span>
                </div>
                <div *ngIf="data.productos && data.productos.length > 0; else noProductos">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0 border-top">
                            <thead style="background:#f5f5f5;">
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr *ngFor="let prod of data.productos">
                                <td>{{ prod.sku }}</td>
                                <td>{{ prod.descripcion }}</td>
                                <td>{{ prod.cantidad }}</td>
                                <td>{{ prod.precio | currency:'MXN':'symbol':'1.2-2' }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <ng-template #noProductos>
                    <div class="text-center text-muted fst-italic pb-2">
                        <i class="fas fa-box-open fa-2x mb-2"></i><br>
                        No hay productos registrados
                    </div>
                </ng-template>
            </div>
        </div>

        <!-- Pagos registrados -->
        <div class="mb-3">
            <div class="bg-white border rounded-4 shadow-sm px-3 pt-3 pb-2">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-money-check-alt me-2 text-primary" style="font-size:1.1rem;"></i>
                    <span class="fw-bold text-secondary" style="margin-left: 5px">Pagos</span>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 d-flex align-items-center">
                        <i class="fas fa-file-invoice-dollar text-primary" style="font-size:1.3rem; margin-right:14px;"></i>
                        <span class="fw-semibold me-2">Total del documento:</span>
                        <span class="fw-bold" style="font-size:1.15rem; color:#1976d2;">
                    {{ data.total | currency:'MXN':'symbol':'1.2-2' }}
                </span>
                    </div>
                    <div class="col-md-6 d-flex align-items-center">
                        <i class="fas fa-coins"
                           style="font-size:1.3rem; margin-right:14px; color:#22b569;"></i>
                        <span class="fw-semibold me-2">Saldo pendiente:</span>
                        <span class="fw-bold"
                              style="font-size:1.15rem; color:#22b569;">
                    {{ data.saldo | currency:'MXN':'symbol':'1.2-2' }}
                </span>
                    </div>
                </div>

                <div *ngIf="data.pagos && data.pagos.length > 0; else noPagos">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0 border-top">
                            <thead style="background:#f5f5f5;">
                            <tr>
                                <th>Folio</th>
                                <th>Monto</th>
                                <th>Moneda</th>
                                <th>Fecha</th>
                                <th>Parcialidad</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr *ngFor="let pago of data.pagos">
                                <td class="text-primary fw-semibold">{{ pago.folio }}</td>
                                <td class="text-success fw-semibold">{{ pago.monto | currency:(pago.moneda || 'MXN'):'symbol':'1.2-2' }}</td>
                                <td>{{ pago.moneda || 'MXN' }}</td>
                                <td>{{ pago.fecha_operacion | date:'yyyy-MM-dd' }}</td>
                                <td>{{ pago.parcialidad }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <ng-template #noPagos>
                    <div *ngIf="!data.pagos || data.pagos.length == 0">
                        <form #formIngreso="ngForm" (ngSubmit)="guardarIngreso()">
                            <div class="row">
                                <!-- Importe -->
                                <div class="col-md-4 mb-3">
                                    <label for="importe" class="form-label">Importe a ingresar</label>
                                    <input
                                        type="number"
                                        id="importe"
                                        name="importe"
                                        class="form-control"
                                        [(ngModel)]="nuevoIngreso.importe"
                                        required
                                        [max]="data.saldo"
                                        step="0.01"
                                    />
                                    <div *ngIf="nuevoIngreso.importe > data.saldo" class="text-danger small mt-1">
                                        El importe no puede ser mayor al saldo pendiente (${{ data.saldo }}).
                                    </div>
                                </div>
                                <!-- Fecha de cobro -->
                                <div class="col-md-4 mb-3">
                                    <label for="fecha_cobro" class="form-label">Fecha de cobro</label>
                                    <input
                                        type="date"
                                        id="fecha_cobro"
                                        name="fecha_cobro"
                                        class="form-control"
                                        [(ngModel)]="nuevoIngreso.fecha_cobro"
                                    />
                                </div>
                                <!-- Referencia -->
                                <div class="col-md-4 mb-3">
                                    <label for="referencia" class="form-label">Referencia</label>
                                    <input
                                        type="text"
                                        id="referencia"
                                        name="referencia"
                                        class="form-control"
                                        [(ngModel)]="nuevoIngreso.referencia"
                                        maxlength="80"
                                    />
                                </div>
                            </div>

                            <div class="row">
                                <!-- Forma de pago -->
                                <div class="col-md-6 mb-3">
                                    <label for="metodo_pago" class="form-label">Forma de pago</label>
                                    <select
                                        id="metodo_pago"
                                        name="metodo_pago"
                                        class="form-control"
                                        [(ngModel)]="nuevoIngreso.metodo_pago"
                                        required
                                    >
                                        <option value="" disabled selected>Selecciona forma de pago</option>
                                        <option *ngFor="let metodo of formas_pago" [value]="metodo.id">
                                            {{ metodo.codigo_sat }} - {{ metodo.descripcion }}
                                        </option>
                                    </select>
                                </div>
                                <!-- Cuenta destino -->
                                <div class="col-md-6 mb-3">
                                    <label for="entidad_destino" class="form-label">Cuenta destino</label>
                                    <select
                                        id="entidad_destino"
                                        name="entidad_destino"
                                        class="form-control"
                                        [(ngModel)]="nuevoIngreso.entidad_destino"
                                        required
                                    >
                                        <option value="" disabled selected>Selecciona cuenta</option>
                                        <option *ngFor="let entidad of entidadesFinancieras" [value]="entidad.id">
                                            {{ entidad.nombre }} ({{ entidad.tipo }}) - {{ entidad.moneda }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Seguimiento -->
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="seguimiento" class="form-label">Seguimiento/Comentario</label>
                                    <textarea
                                        id="seguimiento"
                                        name="seguimiento"
                                        class="form-control"
                                        rows="2"
                                        [(ngModel)]="nuevoIngreso.seguimiento"
                                    ></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" [disabled]="!formIngreso.form.valid">
                                Registrar Ingreso
                            </button>
                        </form>

                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</ng-template>



