<!-- dev.component.html -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Herramientas de Desarrollador</h5>
    </div>
    <div class="card-body">
        <div class="actions-row">
            <!-- Botón existente: Recalcular costo -->
            <button class="btn-action btn-action--amber" (click)="abrirModal(recalcularCosto)">
                <i class="fa fa-credit-card"></i> Recalcular costo
            </button>

            <!-- Botón nuevo: Recalcular inventario -->
            <button class="btn-action btn-action--teal" (click)="abrirModal(recalcularInventarioTpl)">
                <i class="fa fa-database"></i> Recalcular inventario
            </button>
        </div>
    </div>
</div>

<!-- ================== MÓDULO EXISTENTE: COSTO ================== -->
<!-- Modal 1: pedir SKU -->
<ng-template #recalcularCosto let-c="close" let-d="dismiss">
    <div class="modal-header modal-header-soft">
        <div>
            <h4 class="modal-title m-b-0">
                <i class="fa fa-magic m-r-8"></i>
                Estás a punto de entrar a un lugar mágico donde todo puede ser posible
            </h4>
            <div class="modal-subtitle">Recalcula el costo ingresando el SKU.</div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')" id="cerrar_modal">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="container-fluid">
            <div class="form-group row align-items-center">
                <label class="col-sm-3 col-form-label">SKU a recalcular</label>
                <div class="col-sm-9">
                    <div class="input-group">
            <span class="input-group-addon input-group-text-fallback">
              <i class="fa fa-barcode"></i>
            </span>
                        <input
                            type="text"
                            class="form-control"
                            placeholder="Ej. ABC-123"
                            [(ngModel)]="dataCosto.sku"
                            (keyup.enter)="calcularNuevoCosto()"
                            autocomplete="off"
                        />
                    </div>
                    <small class="text-muted">Tip: presiona <b>Enter</b> para recalcular al instante.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="d('cancel')">Cancelar</button>
        <button class="btn btn-primary btn-elevate"
                (click)="calcularNuevoCosto()"
                [disabled]="!dataCosto?.sku || !dataCosto.sku.trim()">
            <i class="fa fa-refresh m-r-6"></i> Recalcular
        </button>
    </div>
</ng-template>

<!-- Modal 2: elegir cómo aplicar -->
<ng-template #aplicarCostoNuevo let-c="close" let-d="dismiss">
    <div class="modal-header modal-header-soft">
        <div>
            <h4 class="modal-title m-b-0">
                <i class="fa fa-check-circle m-r-8"></i>
                Revisa y aplica el nuevo costo
            </h4>
            <div class="modal-subtitle">Verifica los valores antes de aplicar.</div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')" id="cerrar_modal">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="container-fluid">

            <!-- Fila 0: Producto -->
            <div class="row">
                <div class="col-12">
                    <div class="product-banner">
                        <i class="fa fa-tag"></i>
                        <span class="product-name">{{ dataCosto.producto || '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Fila 1: SKU | Stock -->
            <div class="row m-b-0">
                <div class="col-md-6 m-b-10">
                    <div class="stat-card sku-card h-100">
                        <div class="stat-title">SKU</div>
                        <div class="input-group">
              <span class="input-group-addon input-group-text-fallback">
                <i class="fa fa-barcode"></i>
              </span>
                            <input type="text" class="form-control" [(ngModel)]="dataCosto.sku" readonly />
                        </div>
                        <small class="text-muted">Valor informativo.</small>
                    </div>
                </div>

                <div class="col-md-6 m-b-10">
                    <div class="stat-card stock-card h-100">
                        <div class="stat-title">Stock actual</div>
                        <div class="stat-value">{{ dataCosto.stock | number:'1.0-0' }}</div>
                        <small class="text-muted">Existencia real considerando movimientos.</small>
                        <div class="m-t-5" *ngIf="dataCosto.stockSimulado !== null">
                            <div class="stat-subtitle">Stock simulado</div>
                            <div class="stat-value-sm">{{ dataCosto.stockSimulado | number:'1.0-0' }}</div>
                            <small class="text-muted">Proyección con OCs sin compra.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fila 2: Calculado / Provisional / Editado -->
            <div class="row">
                <div class="col-md-4 m-b-10">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo calculado</div>
                            <div class="stat-value">{{ dataCosto.costo | number:'1.2-6' }}</div>
                            <small class="text-muted">Promedio real (compras que afectan costo).</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-primary btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('calculado')"
                                    [disabled]="!esValido(dataCosto.costo)"
                                    title="Aplicar costo calculado">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 m-b-10" *ngIf="dataCosto.costoProvisional !== null">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo provisional</div>
                            <div class="stat-value">{{ dataCosto.costoProvisional | number:'1.2-6' }}</div>
                            <small class="text-muted">Sólo OCs sin compra.</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-info btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('provisional')"
                                    [disabled]="!esValido(dataCosto.costoProvisional)"
                                    title="Aplicar costo provisional">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 m-b-10">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo editado</div>
                            <div class="input-group">
                                <span class="input-group-addon input-group-text-fallback">$</span>
                                <input type="number" min="0" step="0.01" class="form-control text-right" [(ngModel)]="dataCosto.costoEditado">
                            </div>
                            <small class="text-muted">Puedes redondear, ej. 15.20</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-success btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('editado')"
                                    [disabled]="!esValido(dataCosto.costoEditado)"
                                    title="Aplicar costo editado">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="d('cancel')">Cerrar</button>
    </div>
</ng-template>

<!-- ================== MÓDULO NUEVO: INVENTARIO ================== -->
<ng-template #recalcularInventarioTpl let-c="close" let-d="dismiss">
    <div class="modal-header modal-header-soft">
        <div>
            <h4 class="modal-title m-b-0">
                <i class="fa fa-database m-r-8"></i> Recalcular inventario por SKU
            </h4>
            <div class="modal-subtitle">Compara existencias antes/después (pendientes fase 3 con series).</div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <!-- Input SKU + botón calcular -->
        <div class="inv-row">
            <label class="inv-label">SKU</label>
            <div class="inv-input-group">
                <span class="input-group-addon input-group-text-fallback"><i class="fa fa-barcode"></i></span>
                <input type="text" class="form-control" placeholder="Ej. 7500938008169"
                       [(ngModel)]="inv.sku" (keyup.enter)="calcularInventario()" autocomplete="off" />
                <button class="btn btn-primary" (click)="calcularInventario()" [disabled]="!inv.sku || inv.cargando">
                    <i class="fa fa-search m-r-6" *ngIf="!inv.cargando"></i>
                    <span *ngIf="inv.cargando" class="spinner-soft"></span>
                    Calcular
                </button>
            </div>
        </div>

        <!-- Resultado -->
        <div *ngIf="inv.cargado" class="inv-grid">
            <!-- Original -->
            <div class="inv-card">
                <div class="inv-card__header">
                    <div class="inv-title"><i class="fa fa-archive m-r-6"></i> Inventario original</div>
                    <small class="text-muted">Fuente: Busqueda de productos (columna <b>Inventario</b>).</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped m-b-0">
                        <thead>
                        <tr>
                            <th>ALMACÉN</th>
                            <th class="text-right">STOCK</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let r of inv.original">
                            <td>{{ r.almacen }}</td>
                            <td class="text-right">{{ r.stock | number:'1.0-0' }}</td>
                        </tr>
                        <tr *ngIf="!inv.original?.length">
                            <td colspan="2" class="text-center text-muted">Sin datos</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Nuevo -->
            <div class="inv-card">
                <div class="inv-card__header">
                    <div class="inv-title"><i class="fa fa-calculator m-r-6"></i> Inventario nuevo</div>
                    <small class="text-muted">Inventario recalculado (con <b>pedidos pendientes por importar</b>).</small>
                </div>

                <div class="inv-summary" *ngIf="inv.nuevo?.length">
                    <div class="pill"><span>Total pendientes:</span> <b>{{ inv.totalPendientes | number:'1.0-0' }}</b></div>
                    <div class="pill" *ngIf="inv.producto"><span>Producto:</span> <b>{{ inv.producto }}</b></div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover m-b-0">
                        <thead>
                        <tr>
                            <th>ALMACÉN</th>
                            <th class="text-right">STOCK_MOV</th>
                            <th class="text-right">PENDIENTES</th>
                            <th class="text-right">STOCK_RECALC.</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let r of inv.nuevo">
                            <td>{{ r.almacen }}</td>
                            <td class="text-right">{{ r.stock_movimientos | number:'1.0-0' }}</td>
                            <td class="text-right">{{ r.pendientes_fase3 | number:'1.0-0' }}</td>
                            <td class="text-right"><b>{{ r.stock_recalculado | number:'1.0-0' }}</b></td>
                        </tr>
                        <tr *ngIf="!inv.nuevo?.length">
                            <td colspan="4" class="text-center text-muted">Sin datos</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Acciones -->
            <div class="inv-tools">
                <button class="btn btn-outline-secondary" (click)="descargarPendientesExcel()"
                        [hidden]="!inv.cargado || inv.descargando || inv.totalPendientes <= 0">
                    <i class="fa fa-file-excel-o m-r-6" *ngIf="!inv.descargando"></i>
                    <span *ngIf="inv.descargando" class="spinner-soft"></span>
                    Descargar pendientes (Excel)
                </button>

                <button class="btn btn-green" (click)="confirmarAplicacion()"
                        [hidden]="!inv.cargado || inv.totalPendientes <= 0 || inv.aplicando">
                    <i class="fa fa-exclamation-triangle m-r-6" *ngIf="!inv.aplicando"></i>
                    <span *ngIf="inv.aplicando" class="spinner-soft"></span>
                    Aplicar pendientes
                </button>

                <button class="btn btn-purple"
                        (click)="afectarInventario()"
                        [hidden]="!inv.cargado || !inv.puedeAfectar || inv.afectando || inv.totalPendientes > 0">
                    <i class="fa fa-bolt m-r-6" *ngIf="!inv.afectando"></i>
                    <span *ngIf="inv.afectando" class="spinner-soft"></span>
                    Afectar inventario
                </button>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="d('cancel')">Cerrar</button>
    </div>
</ng-template>
