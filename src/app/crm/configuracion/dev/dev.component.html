<!-- dev.component.html -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Herramientas de Desarrollador</h5>
    </div>
    <div class="card-body">
        <div class="actions-row">
            <button class="btn-action btn-action--amber" (click)="abrirModal(recalcularCosto)">
                <i class="fa fa-credit-card"></i> Recalcular costo
            </button>
        </div>
    </div>
</div>

<!-- Modal 1: pedir SKU -->
<ng-template #recalcularCosto let-c="close" let-d="dismiss">
    <div class="modal-header modal-header-soft">
        <div>
            <h4 class="modal-title m-b-0">
                <i class="fa fa-magic m-r-8"></i>
                Estás a punto de entrar a un lugar mágico donde todo puede ser posible
            </h4>
            <div class="modal-subtitle">Recalcula el costo ingresando el SKU.</div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')" id="cerrar_modal">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="container-fluid">
            <div class="form-group row align-items-center">
                <label class="col-sm-3 col-form-label">SKU a recalcular</label>
                <div class="col-sm-9">
                    <div class="input-group">
                        <span class="input-group-addon input-group-text-fallback">
                          <i class="fa fa-barcode"></i>
                        </span>
                        <input
                            type="text"
                            class="form-control"
                            placeholder="Ej. ABC-123"
                            [(ngModel)]="dataCosto.sku"
                            (keyup.enter)="calcularNuevoCosto()"
                            autocomplete="off"
                        />
                    </div>
                    <small class="text-muted">Tip: presiona <b>Enter</b> para recalcular al instante.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="d('cancel')">Cancelar</button>
        <button class="btn btn-primary btn-elevate"
                (click)="calcularNuevoCosto()"
                [disabled]="!dataCosto?.sku || !dataCosto.sku.trim()">
            <i class="fa fa-refresh m-r-6"></i> Recalcular
        </button>
    </div>
</ng-template>

<!-- Modal 2: elegir cómo aplicar -->
<ng-template #aplicarCostoNuevo let-c="close" let-d="dismiss">
    <div class="modal-header modal-header-soft">
        <div>
            <h4 class="modal-title m-b-0">
                <i class="fa fa-check-circle m-r-8"></i>
                Revisa y aplica el nuevo costo
            </h4>
            <div class="modal-subtitle">Verifica los valores antes de aplicar.</div>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="d('Cross click')" id="cerrar_modal">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="container-fluid">

            <!-- Fila 0: Producto a todo lo ancho -->
            <div class="row">
                <div class="col-12">
                    <div class="product-banner">
                        <i class="fa fa-tag"></i>
                        <span class="product-name">{{ dataCosto.producto || '-' }}</span>
                    </div>
                </div>
            </div>

            <!-- Fila 1: SKU | Stock -->
            <div class="row m-b-0">
                <div class="col-md-6 m-b-10">
                    <div class="stat-card sku-card h-100">
                        <div class="stat-title">SKU</div>
                        <div class="input-group">
              <span class="input-group-addon input-group-text-fallback">
                <i class="fa fa-barcode"></i>
              </span>
                            <input type="text" class="form-control" [(ngModel)]="dataCosto.sku" readonly />
                        </div>
                        <small class="text-muted">Valor informativo.</small>
                    </div>
                </div>

                <div class="col-md-6 m-b-10">
                    <div class="stat-card stock-card h-100">
                        <div class="stat-title">Stock actual</div>
                        <div class="stat-value">{{ dataCosto.stock | number:'1.0-0' }}</div>
                        <small class="text-muted">Existencia real considerando movimientos.</small>

                        <div class="m-t-5" *ngIf="dataCosto.stockSimulado !== null">
                            <div class="stat-subtitle">Stock simulado</div>
                            <div class="stat-value-sm">{{ dataCosto.stockSimulado | number:'1.0-0' }}</div>
                            <small class="text-muted">Proyección con OCs sin compra.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fila 2: Calculado / Provisional / Editado (botón compacto) -->
            <div class="row">
                <!-- Calculado -->
                <div class="col-md-4 m-b-10">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo calculado</div>
                            <div class="stat-value">{{ dataCosto.costo | number:'1.2-6' }}</div>
                            <small class="text-muted">Promedio real (compras que afectan costo).</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-primary btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('calculado')"
                                    [disabled]="!esValido(dataCosto.costo)"
                                    title="Aplicar costo calculado">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Provisional -->
                <div class="col-md-4 m-b-10" *ngIf="dataCosto.costoProvisional !== null">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo provisional</div>
                            <div class="stat-value">{{ dataCosto.costoProvisional | number:'1.2-6' }}</div>
                            <small class="text-muted">Sólo OCs sin compra.</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-info btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('provisional')"
                                    [disabled]="!esValido(dataCosto.costoProvisional)"
                                    title="Aplicar costo provisional">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Editado -->
                <div class="col-md-4 m-b-10">
                    <div class="stat-card cost-card h-100 d-flex flex-column">
                        <div>
                            <div class="stat-title">Costo editado</div>
                            <div class="input-group">
                                <span class="input-group-addon input-group-text-fallback">$</span>
                                <input type="number"
                                       min="0" step="0.01"
                                       class="form-control text-right"
                                       [(ngModel)]="dataCosto.costoEditado">
                            </div>
                            <small class="text-muted">Puedes redondear, ej. 15.20</small>
                        </div>
                        <div class="stat-actions mt-auto">
                            <button class="btn btn-success btn-elevate btn-icon"
                                    (click)="aplicarNuevoCosto('editado')"
                                    [disabled]="!esValido(dataCosto.costoEditado)"
                                    title="Aplicar costo editado">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer simple -->
    <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="d('cancel')">Cerrar</button>
    </div>
</ng-template>




