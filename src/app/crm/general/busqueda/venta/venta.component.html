<div class="card">
    <div class="card-header">
        <h5>Ventas encontradas</h5>
    </div>
    <div class="card-block table-responsive">
        <div class="row">
            <div class="col-md-12">
                <table
                    class="table table-striped"
                    id="general_busqueda_venta"
                >
                    <thead>
                    <tr>
                        <th>Documento</th>
                        <th>Venta</th>
                        <th>Marketplace</th>
                        <th>Cliente</th>
                        <th>Paquetería</th>
                        <th>Vendedor</th>
                        <th>Fase</th>
                        <th>Fecha</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr
                        *ngFor="let venta of ventas"
                        class="{{
                                        venta.status == 0 ? 'cancelado' : ''
                                    }}"
                    >
                        <td>
                            <button
                                (click)="
                                                detalleVenta(modalventa,venta.id)
                                            "
                                class="btn btn-info btn-sm"
                            >
                                {{ venta.id }}
                            </button>
                        </td>
                        <td>{{ venta.no_venta }}</td>
                        <td>
                            {{
                                venta.marketplace +
                                " / " +
                                venta.area
                            }}
                        </td>
                        <td>{{ venta.cliente }}</td>
                        <td>{{ venta.paqueteria }}</td>
                        <td>{{ venta.usuario }}</td>
                        <td>
                            {{
                                venta.modificacion &&
                                venta.id_fase == 2
                                    ? "Pendiente de revisión por Soporte"
                                    : venta.id_fase == 6
                                        ? venta.eliminada
                                            ? "Terminado / Eliminada"
                                            : venta.cancelado
                                                ? "Terminado / Cancelada"
                                                : venta.timbrado
                                                    ? "Terminado / Timbrada"
                                                    : "Terminado / No timbrada"
                                        : venta.fase
                            }}
                        </td>
                        <td>{{ venta.created_at }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #modalventa let-d="dismiss">
    <!-- CABECERA -->
    <div class="modal-header d-flex align-items-center justify-content-between"
         style="background:#f8fafc; border-bottom:1px solid #e5e7eb;">

        <!-- TÍTULO Y ICONO -->
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-file-invoice-dollar" style="font-size:1.3rem; color:#6366f1;"></i>
            <h5 class="modal-title fw-bold mb-0 text-dark">
                Información de la venta #{{ final_data.documento }}
            </h5>
        </div>

        <!-- BOTONES Y "X" -->
        <div class="d-flex align-items-center" style="gap: 0.75rem;">
            <button class="btn btn-success btn-sm fw-bold"
                    style="white-space:nowrap;"
                    (click)="crearNotaCredito(final_data.documento)">
                <i class="fas fa-receipt me-1"></i> Generar Nota de Crédito
            </button>
            <button class="btn btn-primary btn-sm fw-bold"
                    style="white-space:nowrap;"
                    (click)="crearRefacturacion(final_data.documento)">
                <i class="fas fa-file-invoice me-1"></i> Crear Refacturación
            </button>
            <button type="button"
                    class="btn p-0 text-secondary"
                    aria-label="Close"
                    style="margin-left:1.25rem; font-size:1.4rem;"
                    (click)="d('Cross click')">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>


    <!-- CUERPO -->
    <div class="modal-body" style="background:#f8fafc;">

        <div class="container-fluid py-2">

            <!-- CARDS SUPERIORES -->
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="card rounded-4 shadow-sm border h-100">
                        <div class="card-body py-3">
                            <div class="d-flex align-items-center gap-2 py-1">
                                <i class="fas fa-hashtag text-primary"></i>
                                <span class="fw-bold text-secondary">N° de venta</span>
                            </div>
                            <div class="fw-semibold text-dark fs-5">{{ data.no_venta }}</div>
                            <div *ngIf="data.marketplace == 'MERCADOLIBRE' && data.comentario">
                                <div class="d-flex align-items-center gap-2 py-1 mt-2">
                                    <i class="fas fa-box text-primary"></i>
                                    <span class="fw-bold text-secondary">Pack ID</span>
                                </div>
                                <div class="fw-semibold text-dark fs-5">{{ data.comentario }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card rounded-4 shadow-sm border h-100">
                        <div class="card-body py-3">
                            <div class="d-flex align-items-center gap-2 py-1">
                                <i class="fas fa-store text-success"></i>
                                <span class="fw-bold text-secondary">Marketplace / Área</span>
                            </div>
                            <div class="fw-semibold text-dark fs-5">{{ data.marketplace }} / {{ data.area }}</div>
                            <div class="text-end mt-2" *ngIf="data.marketplace == 'MERCADOLIBRE'">
                                <button class="btn btn-outline-primary btn-sm" (click)="informacionExtraMercadolibre(modalinformacionmercadolibre)">
                                    Más información
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card rounded-4 shadow-sm border h-100">
                        <div class="card-body py-3">
                            <div class="d-flex align-items-center gap-2 py-1">
                                <i class="fas fa-warehouse text-warning"></i>
                                <span class="fw-bold text-secondary">Empresa / Almacén</span>
                            </div>
                            <div class="fw-semibold text-dark fs-5">{{ data.empresa_razon }} / {{ data.almacen }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIENTE Y DIRECCIÓN -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center gap-2 py-1">
                            <i class="fas fa-user text-success"></i>
                            <span class="fw-bold text-secondary">Cliente</span>
                        </div>
                        <div class="fw-semibold">{{ data.cliente }}</div>
                        <div class="text-muted small">{{ data.rfc }}</div>
                        <div class="text-muted small">{{ data.correo }}</div>
                        <div class="text-muted small">{{ data.telefono }}</div>
                        <div class="text-muted small">{{ data.telefono_alt }}</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center gap-2 py-1">
                            <i class="fas fa-map-marker-alt text-danger"></i>
                            <span class="fw-bold text-secondary">Dirección de envío</span>
                        </div>
                        <div class="fw-semibold text-dark">
                            {{ $any(data).direccion?.calle }} {{ $any(data).direccion?.numero }} {{ $any(data).direccion?.numero_int }}
                        </div>
                        <div class="text-muted small">
                            {{ $any(data).direccion?.colonia }}, {{ $any(data).direccion?.ciudad }}, {{ $any(data).direccion?.estado }}, CP {{ $any(data).direccion?.codigo_postal }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div *ngIf="data.garantia_devolucion"
                         class="bg-white rounded-4 shadow-sm p-3 h-100 border-top"
                         style="border-color: #fd7e14 !important;">
                        <div class="d-flex justify-content-between align-items-center h-100">
                            <div>
                                <div class="d-flex align-items-center gap-2 py-1">
                                    <i class="fas fa-undo text-warning"></i>
                                    <span class="fw-bold text-secondary">Devolución / Garantía Asociada</span>
                                </div>
                                <div class="fw-semibold text-dark">
                                    {{ data.garantia_devolucion.tipo }} #{{ data.garantia_devolucion.id }}
                                </div>
                                <div class="text-muted small">
                                    Creado por: {{ data.garantia_devolucion.creador }}
                                </div>
                            </div>
                            <div class="align-self-start">
                                <button class="btn btn-outline-warning btn-sm" (click)="descargarGarantiaPDF(data.garantia_devolucion.id)">
                                    Descargar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div *ngIf="data.nota_de_credito"
                         class="bg-white rounded-4 shadow-sm p-3 h-100 border-top"
                         style="border-color: #0d6efd !important;">
                        <div class="d-flex justify-content-between align-items-center h-100">
                            <div>
                                <div class="d-flex align-items-center gap-2 py-1">
                                    <i class="fas fa-receipt text-primary"></i>
                                    <span class="fw-bold text-secondary">Nota de Crédito Generada</span>
                                </div>
                                <div class="fw-semibold text-dark">
                                    Folio #{{ data.nota_de_credito.id }}
                                </div>
                                <div class="text-muted small">
                                    Fecha: {{ data.nota_de_credito.created_at | date:'yyyy-MM-dd HH:mm' }}
                                </div>
                            </div>
                            <div class="align-self-start">
                                <button class="btn btn-primary btn-sm fw-bold" (click)="descargarNotaCreditoPDF(data.nota_de_credito.id)">
                                    <i class="fas fa-download me-1"></i> Descargar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección exclusiva para la guía -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-barcode text-primary"></i>
                    <span class="fw-bold text-secondary">Guía de envío</span>
                </div>
                <div *ngIf="data.guias && data.guias.length > 0; else noGuia">
                    <div class="fw-semibold fs-5">{{ data.guias[0].guia }}</div>
                </div>
                <ng-template #noGuia>
                    <div class="text-muted fst-italic">Sin guía registrada</div>
                </ng-template>
            </div>

            <!-- DATOS ADICIONALES -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Referencia</div>
                        <div class="fw-semibold text-dark">{{ data.referencia }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Periodo de pago</div>
                        <div class="fw-semibold text-dark">{{ data.periodo }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Moneda | T.C</div>
                        <div class="fw-semibold text-dark">{{ data.moneda }} | $ {{ data.tipo_cambio }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Paquetería</div>
                        <div class="fw-semibold text-dark">{{ data.paqueteria }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Fecha de surtido</div>
                        <div class="fw-semibold text-dark">
                            {{
                                data.fecha_surtido != "0000-00-00 00:00:00"
                                    ? moment(data.fecha_surtido).format("LLLL")
                                    : "SIN REGISTRO"
                            }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="small fw-bold text-secondary">Surtido por</div>
                        <div class="fw-semibold text-dark">{{ data.empaquetador || 'SIN REGISTRO' }}</div>
                    </div>
                </div>
            </div>

            <!-- PRODUCTOS -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <i class="fas fa-boxes text-primary"></i>
                    <span class="fw-bold text-secondary">Productos</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0 border-top">
                        <thead class="bg-light text-secondary text-uppercase small">
                        <tr>
                            <th class="text-start">Código</th>
                            <th class="text-start">Descripción</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio</th>
                            <th class="text-center">Series</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let prod of data.productos">
                            <td>{{ prod.sku }}</td>
                            <td>{{ prod.descripcion }}</td>
                            <td class="text-center">{{ prod.cantidad }}</td>
                            <td class="text-end">
                                {{ prod.precio | currency:'MXN':'symbol':'1.2-2' }}
                            </td>
                            <td class="text-center">
                                <button *ngIf="prod.series && prod.series.length > 0"
                                        class="btn btn-outline-primary btn-sm"
                                        (click)="verSeries(prod.series, modalserierecibidas)">
                                    <i class="fas fa-barcode me-1"></i>Ver series ({{ prod.series.length }})
                                </button>
                            </td>
                        </tr>
                        </tbody>
                        <tfoot class="fw-bold">
                        <tr>
                            <td></td>
                            <td></td>
                            <td class="text-end">Total:</td>
                            <td class="text-end text-success">{{ totalDocumento() | currency:'MXN':'symbol':'1.2-2' }}</td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="text-muted small mt-1">
                    Precios en pesos con IVA incluido.
                </div>
            </div>

            <!-- PAGOS -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-money-check-alt text-success"></i>
                    <span class="fw-bold text-secondary">Pagos registrados</span>
                </div>

                <div *ngIf="data.movimientos_contables && data.movimientos_contables.length > 0; else noPagos">
                    <div class="row g-3">
                        <div class="col-md-4" *ngFor="let mov of data.movimientos_contables">
                            <div *ngIf="mov" class="card border shadow-sm rounded-4 h-100 p-0">
                                <div
                                    class="d-flex justify-content-between align-items-center p-2 rounded-top-4"
                                    [ngStyle]="{
                                              'background-color': mov.activo == 1 ? 'rgba(25, 135, 84, 0.15)' : 'rgba(220, 53, 69, 0.15)'
                                          }"
                                    >
                                    <div class="fw-bold text-dark" style="font-size: 1rem;">
                                        <i class="fas fa-file-invoice-dollar me-1 text-secondary"></i> {{ mov.folio }}
                                    </div>

                                    <div class="fw-bold"
                                         [ngClass]="mov.activo == 1 ? 'text-success' : 'text-danger'"
                                         style="font-size: 1rem;">
                                        {{ mov.activo == 1 ? 'Activo' : 'Inactivo' }}
                                    </div>
                                </div>

                                <div class="card-body p-2">
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <span class="text-muted">Monto</span><br>
                                            <span class="fw-semibold text-success">
                                    {{ mov.monto_aplicado | currency:mov.moneda_aplicada:'symbol':'1.2-2' }}
                                </span>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <span class="text-muted">Moneda</span><br>
                                            <span class="fw-semibold">{{ mov.moneda_aplicada }}</span>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <span class="text-muted">Forma pago</span><br>
                                            <span class="fw-semibold">{{ mov.forma_pago || 'N/A' }}</span>
                                        </div>
                                        <div class="col-6 mb-2">
                                            <span class="text-muted">Fecha</span><br>
                                            <span class="fw-semibold">{{ mov.fecha_movimiento | date:'yyyy-MM-dd HH:mm' }}</span>
                                        </div>
                                        <div class="col-12 mb-2">
                                            <span class="text-muted">Origen</span><br>
                                            <span class="fw-semibold">{{ mov.origen_nombre || 'N/A' }}</span>
                                        </div>
                                        <div class="col-12">
                                            <span class="text-muted">Destino</span><br>
                                            <span class="fw-semibold">{{ mov.destino_nombre || 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #noPagos>
                    <div class="text-center text-muted fst-italic py-3">
                        <i class="fas fa-money-bill-wave fa-2x mb-2"></i><br>
                        No hay pagos registrados
                    </div>
                </ng-template>
            </div>

            <!-- SEGUIMIENTO -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-comments text-secondary"></i>
                    <span class="fw-bold text-secondary">Seguimiento</span>
                </div>
                <app-new-editor [(ngModel)]="final_data.seguimiento"></app-new-editor>
                <div *ngFor="let seguimiento of data.seguimiento_anterior" class="border rounded p-2 mb-2 bg-light">
                    <div class="fw-bold small mb-1">{{ seguimiento.nombre }} - {{ seguimiento.created_at }}</div>
                    <div [innerHTML]="seguimiento.seguimiento"></div>
                </div>
            </div>

            <!-- ARCHIVOS -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3 border-top" style="border-color:#d1d5db !important;">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-paperclip text-secondary"></i>
                    <span class="fw-bold text-secondary">Archivos</span>
                </div>

                <!-- CARGA DE NUEVOS ARCHIVOS -->
                <div class="mb-2">
                    <input type="file" class="form-control mb-2" id="archivos">

                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="small fw-bold">Tipo de archivo</label>
                            <select class="form-control" [(ngModel)]="archivo.guia">
                                <option value="">Seleccione</option>
                                <option value="1">Archivo de información</option>
                                <option value="2">Guía de embarque</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold">Tamaño de hoja</label>
                            <select class="form-control" [(ngModel)]="archivo.impresora">
                                <option value="">Seleccione</option>
                                <option *ngFor="let impresora of impresoras" [value]="impresora.id">
                                    {{ impresora.nombre }} - {{ impresora.tamanio }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-12 mt-2">
                            <button class="btn btn-primary btn-sm w-100 fw-bold" (click)="agregarArchivo()">
                                <i class="fas fa-plus me-1"></i> Agregar archivo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ARCHIVOS NUEVOS A SUBIR -->
                <div class="mt-3" *ngIf="final_data.archivos.length > 0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle border mb-0 rounded-4 overflow-hidden">
                            <thead class="bg-light text-secondary small text-uppercase">
                            <tr>
                                <th>Archivo</th>
                                <th>Tipo</th>
                                <th>Tamaño hoja</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr *ngFor="let archivo of final_data.archivos; let i = index">
                                <td>
                                    <i class="fas fa-file-alt text-primary me-1"></i> {{ archivo.nombre || archivo.archivo }}
                                </td>
                                <td>
                                    {{ archivo.guia == '1' ? 'Información' : 'Guía de embarque' }}
                                </td>
                                <td>
                                    {{ nombreTamanioHoja(archivo.impresora) }}
                                </td>
                                <td>
                        <span class="text-danger fw-bold" style="cursor:pointer;" (click)="quitarArchivo(i)">
                            <i class="fas fa-trash-alt me-1"></i> Quitar
                        </span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ARCHIVOS YA EXISTENTES -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5 class="sub-title">Archivos Información</h5>
                        <ul class="list-group" *ngIf="archivos_comun.length > 0">
                            <li *ngFor="let archivo of archivos_comun" class="list-group-item">
                                <i class="fa fa-{{archivo.icon}} fa-lg"></i>
                                <span style="cursor:pointer" (click)="verArchivo(archivo.dropbox)">
                        {{ archivo.archivo }}
                    </span>
                                <i class="fa fa-times text-danger float-end" (click)="borrarArchivo(archivo.dropbox)"></i>
                            </li>
                        </ul>
                        <div *ngIf="archivos_comun.length == 0" class="text-muted small">Sin archivos</div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="sub-title">Archivos Guía</h5>
                        <ul class="list-group" *ngIf="archivos_guia.length > 0">
                            <li *ngFor="let archivo of archivos_guia" class="list-group-item">
                                <i class="fa fa-{{archivo.icon}} fa-lg"></i>
                                <span style="cursor:pointer" (click)="verArchivo(archivo.dropbox)">
                        {{ archivo.archivo }}
                    </span>
                                <i class="fa fa-times text-danger float-end" (click)="borrarArchivo(archivo.dropbox)"></i>
                            </li>
                        </ul>
                        <div *ngIf="archivos_guia.length == 0" class="text-muted small">Sin archivos</div>
                    </div>
                </div>
            </div>

            <!-- BOTÓN GUARDAR -->
            <div class="mt-3">
                <button class="btn btn-primary btn-sm w-100 fw-bold" [disabled]="final_data.seguimiento==''" (click)="guardarDocumento()">
                    Guardar
                </button>
            </div>

        </div>
    </div>
</ng-template>

<ng-template #modalserierecibidas let-d="dismiss">
    <div class="modal-header">
        <h4 class="modal-title">Series</h4>
        <button type="button" class="close" aria-label="Close"
                (click)="d('Cross click')" id="cerrar_modal_serie">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body table-responsive">
        <div class="form-horizontal form-bordered">
            <div class="form-group group-div">
                <label class="col-form-label col-sm-2">Series</label>
                <div class="col-sm-10 inline-block">
                    <ul class="list-group m-b-20" id="ul_series">
                        <li class="list-group-item"
                            *ngFor="let serie of seriesProductoSeleccionado">
                            {{ serie.serie }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</ng-template>


<ng-template #modalinformacionmercadolibre let-d="dismiss">
    <!-- CABECERA -->
    <div class="modal-header d-flex align-items-center justify-content-between" style="background:#3f51b5; color:#fff;">
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-store"></i>
            <h5 class="modal-title mb-0">Información de la venta MercadoLibre</h5>
        </div>
        <button type="button" class="btn p-0 text-white" aria-label="Close" (click)="d('Cross click')">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- CUERPO -->
    <div class="modal-body" style="background:#f8fafc;">
        <div class="container-fluid py-2">

            <!-- Información general -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-file-invoice-dollar text-primary"></i>
                    <span class="fw-bold text-secondary fs-6">Venta</span>
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div>
                            <span class="fs-6 text-secondary fw-bold">ID venta:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.id }}</span>
                        </div>
                        <div *ngIf="$any(data).extra_info.pack_id">
                            <span class="fs-6 text-secondary fw-bold">Pack ID:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.pack_id }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Fecha de creación:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.date_created }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Fecha de cierre:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.date_closed }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Estado:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.status }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Total:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ $any(data).extra_info.total_amount }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cliente -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-user text-success"></i>
                    <span class="fw-bold text-secondary fs-6">Cliente</span>
                </div>
                <div>
                    <span class="fs-6 text-secondary fw-bold">Pseudónimo:</span>
                    <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.buyer.nickname }}</span>
                </div>
                <div>
                    <span class="fs-6 text-secondary fw-bold">Nombre:</span>
                    <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.buyer.first_name }} {{ $any(data).extra_info.buyer.last_name }}</span>
                </div>
                <div>
                    <span class="fs-6 text-secondary fw-bold">Email:</span>
                    <span class="fw-semibold fs-6 text-dark">{{ $any(data).extra_info.buyer.email }}</span>
                </div>
            </div>

            <!-- Cobros -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-money-bill-wave text-primary"></i>
                    <span class="fw-bold text-secondary fs-6">Cobros</span>
                </div>
                <div *ngIf="$any(data).extra_info.payments.length > 0; else noPagos">
                    <div *ngFor="let cobro of $any(data).extra_info.payments" class="border rounded p-2 mb-2">
                        <div>
                            <span class="fs-6 text-secondary fw-bold">ID:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.id }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Fecha creación:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.date_created }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Última modificación:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.date_last_modified }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Estado:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.status }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Detalle:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.status_detail }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Total transacción:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ cobro.transaction_amount }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Costo envío:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ cobro.shipping_cost }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Cupon:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ cobro.coupon_amount }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Comisión:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ cobro.marketplace_fee }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Tipo de pago:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.payment_type }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Método de pago:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ cobro.payment_method_id }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Total a plazos:</span>
                            <span class="fw-semibold fs-6 text-dark">${{ cobro.installment_amount }}</span>
                        </div>
                    </div>
                </div>
                <ng-template #noPagos>
                    <div class="text-center text-muted fst-italic py-2">
                        <i class="fas fa-money-check fa-2x mb-2"></i><br>
                        Sin cobros registrados
                    </div>
                </ng-template>
            </div>

            <!-- Productos -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-box-open text-success"></i>
                    <span class="fw-bold text-secondary fs-6">Productos</span>
                </div>
                <div *ngFor="let producto of $any(data).extra_info.order_items" class="border rounded p-2 mb-2">
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Producto:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ producto.item.title }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Seller SKU:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ producto.item.seller_sku }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Garantía:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ producto.warranty }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Cantidad:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ producto.quantity }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Precio:</span>
                        <span class="fw-semibold fs-6 text-dark">${{ producto.unit_price }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Comisión:</span>
                        <span class="fw-semibold fs-6 text-dark">${{ producto.sale_fee }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Tipo producto:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ producto.listing_type_id }}</span>
                    </div>
                    <div *ngIf="producto.item.variation_attributes?.length">
                        <span class="fs-6 text-secondary fw-bold">Variaciones:</span>
                        <ul class="mb-0">
                            <li *ngFor="let variacion of producto.item.variation_attributes">
                                <span class="fs-6 text-secondary fw-bold">{{ variacion.name }}:</span>
                                <span class="fw-semibold fs-6 text-dark">{{ variacion.value_name }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Envío -->
            <!-- Envío -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-truck text-warning"></i>
                    <span class="fw-bold text-secondary fs-6">Envío</span>
                </div>

                <!-- primero validamos que exista extra_info.shipping -->
                <div *ngIf="$any(data)?.extra_info?.status !== 'cancelled' && $any(data)?.extra_info?.shipping as ship; else sinEnvio">
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Estado:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.status || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Subestado:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.substatus || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Logística:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.tracking_method || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Guía:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.tracking_number || 'N/D' }}</span>
                    </div>

                    <!-- status_history puede NO existir: usa ?. y fallback -->
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha creación:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.date_created || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha primera impresión:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.date_first_printed || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha envío listo:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.status_history?.date_ready_to_ship || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha envío:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.status_history?.date_shipped || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Última actualización:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.last_updated || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha entrega:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.status_history?.date_delivered || 'N/D' }}</span>
                    </div>
                    <div>
                        <span class="fs-6 text-secondary fw-bold">Fecha primera visita:</span>
                        <span class="fw-semibold fs-6 text-dark">{{ ship?.status_history?.date_first_visit || 'N/D' }}</span>
                    </div>
                </div>

                <ng-template #sinEnvio>
                    <div class="text-center text-muted fst-italic py-2">
                        <i class="fas fa-truck-loading fa-2x mb-2"></i><br>
                        Sin información de envío disponible
                    </div>
                </ng-template>
            </div>

            <!-- Reclamos -->
            <div class="bg-white rounded-4 shadow-sm p-3 mb-3">
                <div class="d-flex align-items-center gap-2 py-1 mb-2">
                    <i class="fas fa-exclamation-circle text-danger"></i>
                    <span class="fw-bold text-secondary fs-6">Reclamos</span>
                </div>
                <div *ngIf="$any(data).extra_info.mediations?.length > 0; else noReclamos">
                    <div *ngFor="let reclamo of $any(data).extra_info.mediations" class="border rounded p-2 mb-2">
                        <div>
                            <span class="fs-6 text-secondary fw-bold">ID:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ reclamo.id }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Tipo:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ reclamo.type }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Escenario:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ reclamo.stage }}</span>
                        </div>
                        <div>
                            <span class="fs-6 text-secondary fw-bold">Estado:</span>
                            <span class="fw-semibold fs-6 text-dark">{{ reclamo.status }}</span>
                        </div>
                    </div>
                </div>
                <ng-template #noReclamos>
                    <div class="text-center text-muted fst-italic py-2">
                        <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                        Sin reclamos
                    </div>
                </ng-template>
            </div>
        </div>
    </div>
</ng-template>
